<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Incharge Self Attendance System</title>
    <style>
        body { font-family: Arial, sans-serif; background-color: #f0f8ff; color: #333; }
        .container { max-width: 600px; margin: auto; padding: 20px; background: linear-gradient(135deg, #ffffff, #e6f7ff); border-radius: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        button { background-color: #4CAF50; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; transition: background-color 0.3s; }
        button:hover { background-color: #45a049; }
        select, input { padding: 8px; border-radius: 5px; border: 1px solid #ddd; width: 100%; margin-top: 5px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 12px; text-align: left; }
        th { background-color: #4CAF50; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        .absent { color: #f44336; }
        .half-day { color: #FF9800; }
        .present { color: #4CAF50; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-database.js"></script>
</head>
<body>
    <div class="container">
        <h1>Incharge Self Attendance System</h1>
        <button onclick="showPage('submitPage')">Submit Attendance</button>
        <button onclick="showPage('reportPage')">Monthly Report</button>

        <div id="submitPage" class="page">
            <h2>Submit Attendance</h2>
            <label for="name">Name:</label>
            <select id="name">
                <option value="BHAVESHBHAI JOLIYA">BHAVESHBHAI JOLIYA</option>
                <option value="PRAVINBHAI SOLANKI">PRAVINBHAI SOLANKI</option>
                <option value="THIRUPATHI VASANTH REDDY">THIRUPATHI VASANTH REDDY</option>
                <option value="SUNIL VINAYAK LUTE">SUNIL VINAYAK LUTE</option>
                <option value="Balaji AshokRao More">Balaji AshokRao More</option>
                <option value="JOLIYA VIPUL RAMJIBHAI">JOLIYA VIPUL RAMJIBHAI</option>
                <option value="LALJI TIWARI">LALJI TIWARI</option>
                <option value="Ranveer Singh">Ranveer Singh</option>
                <option value="BANOTH VAMSHI">BANOTH VAMSHI</option>
                <option value="P Ananth Reddy">P Ananth Reddy</option>
                <option value="AMAN KUMAR">AMAN KUMAR</option>
                <option value="LOKESH YADAV">LOKESH YADAV</option>
                <option value="SUNNY SINGH">SUNNY SINGH</option>
                <option value="Anirudh Kumar">Anirudh Kumar</option>
                <option value="Gauri Shankar Sah">Gauri Shankar Sah</option>
                <option value="CHANDAN KUMAR THAKUR">CHANDAN KUMAR THAKUR</option>
                <option value="BALRAM KUMAR">BALRAM KUMAR</option>
                <option value="KOTAM HARISH KUMAR REDDY">KOTAM HARISH KUMAR REDDY</option>
                <option value="M.VITTAL">M.VITTAL</option>
                <option value="ROHIT KUMAR SINGH">ROHIT KUMAR SINGH</option>
                <option value="PALLA SOMASANKAR">PALLA SOMASANKAR</option>
                <option value="PATLOLLA VINAY REDDY">PATLOLLA VINAY REDDY</option>
                <option value="DESH PANDE AKHIL">DESH PANDE AKHIL</option>
                <option value="raunak sir">raunak sir</option>
            </select>
            <br><br>
            <label for="date">Date:</label>
            <input type="date" id="date">
            <br><br>
            <label for="attendance">Attendance:</label>
            <select id="attendance">
                <option value="absent">Absent</option>
                <option value="half_day_morning">Half Day (Morning)</option>
                <option value="half_day_evening">Half Day (Evening)</option>
            </select>
            <br><br>
            <button onclick="submitAttendance()">Submit</button>
        </div>

        <div id="reportPage" class="page hidden">
            <h2>Monthly Report</h2>
            <label for="month">Select Month:</label>
            <select id="month" onchange="generateReport()">
                <option value="January">January</option>
                <option value="February">February</option>
                <option value="March">March</option>
                <option value="April">April</option>
                <option value="May">May</option>
                <option value="June">June</option>
                <option value="July">July</option>
                <option value="August">August</option>
                <option value="September">September</option>
                <option value="October">October</option>
                <option value="November">November</option>
                <option value="December">December</option>
            </select>
            <div id="reportContent"></div>
        </div>
    </div>

    <script>
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyBRYM58HonJ6iegV_wpb9I59szB_Iv-UGU",
  authDomain: "incharges-attendance.firebaseapp.com",
  projectId: "incharges-attendance",
  storageBucket: "incharges-attendance.firebasestorage.app",
  messagingSenderId: "807291366429",
  appId: "1:807291366429:web:88ca7f069f9ec004d86af4",
  measurementId: "G-TVQQF1LNN9"
};

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        const attendanceRef = database.ref('attendance'); // Reference to the 'attendance' node in your database

        let attendanceData = []; // This will now be populated from Firebase

        // Function to fetch attendance data from Firebase
        async function fetchAttendanceData() {
            try {
                const snapshot = await attendanceRef.once('value');
                const data = snapshot.val();
                attendanceData = [];
                if (data) {
                    // Convert the object of records into an array
                    for (let key in data) {
                        attendanceData.push(data[key]);
                    }
                }
                console.log("Attendance data fetched:", attendanceData);
                // If report page is active, regenerate report with new data
                if (!document.getElementById('reportPage').classList.contains('hidden')) {
                    generateReport();
                }
            } catch (error) {
                console.error("Error fetching attendance data:", error);
            }
        }

        // Call fetchAttendanceData when the page loads
        document.addEventListener('DOMContentLoaded', fetchAttendanceData);

        function showPage(page) {
            document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
            document.getElementById(page).classList.remove('hidden');
            if (page === 'reportPage') {
                fetchAttendanceData(); // Fetch data before generating report
            }
        }

        async function submitAttendance() {
            const name = document.getElementById('name').value;
            const date = document.getElementById('date').value;
            const attendance = document.getElementById('attendance').value;

            if (name && date && attendance) {
                const newAttendanceRecord = { name, date, attendance };
                try {
                    // Push data to Firebase Realtime Database
                    await attendanceRef.push(newAttendanceRecord);
                    alert('Attendance submitted successfully!');
                    document.getElementById('date').value = '';
                    document.getElementById('attendance').value = 'absent';
                    fetchAttendanceData(); // Refresh data after submission
                } catch (error) {
                    console.error("Error submitting attendance:", error);
                    alert('Failed to submit attendance. Please try again.');
                }
            } else {
                alert('Please fill all fields.');
            }
        }

        function generateReport() {
            const selectedMonth = document.getElementById('month').value;
            const selectedYear = new Date().getFullYear(); // Get current year
            const workingDays = getWorkingDaysInMonth(selectedMonth, selectedYear);
            
            // First initialize all names with full present count
            const reportContent = {};
            Array.from(document.getElementById('name').options).forEach(option => {
                reportContent[option.value] = { 
                    present: workingDays, 
                    absent: 0, 
                    halfDay: 0 
                };
            });
            
            // Then apply any recorded attendance data
            attendanceData.forEach(record => {
                const { name, date, attendance } = record;
                const recordDate = new Date(date);
                const month = recordDate.toLocaleString('default', { month: 'long' });
                const year = recordDate.getFullYear();

                if (month === selectedMonth && year === selectedYear && reportContent[name]) {
                    if (attendance === 'absent') {
                        reportContent[name].absent += 1;
                        reportContent[name].present -= 1;
                    } else if (attendance.includes('half_day')) {
                        reportContent[name].halfDay += 0.5;
                        reportContent[name].present -= 0.5;
                    }
                }
            });

            let reportHTML = '<table><tr><th>Name</th><th>Present</th><th>Absent</th><th>Half Day</th></tr>';
            for (const [name, data] of Object.entries(reportContent)) {
                reportHTML += `<tr><td>${name}</td><td class="present">${data.present}</td>
                <td class="absent" onclick="showAbsentDates('${name}', '${selectedMonth}')">${data.absent}</td>
                <td class="half-day">${data.halfDay}</td></tr>`;
            }
            reportHTML += '</table>';

            // Add absent dates listing
            reportHTML += '<h3>Absent Details</h3><table><tr><th>Date</th><th>Absentees</th></tr>';
            const absentByDate = {};
            attendanceData.forEach(record => {
                const recordDate = new Date(record.date);
                const month = recordDate.toLocaleString('default', { month: 'long' });
                const year = recordDate.getFullYear();

                if (month === selectedMonth && year === selectedYear && record.attendance === 'absent') {
                    if (!absentByDate[record.date]) {
                        absentByDate[record.date] = [];
                    }
                    absentByDate[record.date].push(record.name);
                }
            });
            Object.entries(absentByDate).sort((a, b) => new Date(a[0]) - new Date(b[0])).forEach(([date, names]) => {
                reportHTML += `<tr><td>${date}</td><td>${names.join(', ')}</td></tr>`;
            });
            reportHTML += '</table>';

            document.getElementById('reportContent').innerHTML = reportHTML;
        }

        function getWorkingDaysInMonth(monthName, year) {
    // This function now always returns 30 working days.
    return 30; // Assuming 30 days are working days for now
}

        function showAbsentDates(name, month) {
            const selectedYear = new Date().getFullYear();
            const dates = attendanceData
                .filter(r => r.name === name && 
                       r.attendance === 'absent' && 
                       new Date(r.date).toLocaleString('default', { month: 'long' }) === month &&
                       new Date(r.date).getFullYear() === selectedYear)
                .map(r => r.date);
            
            if (dates.length) {
                alert(`${name} was absent on:\n${dates.join('\n')}`);
            } else {
                alert(`${name} has no recorded absences for ${month}`);
            }
        }
    </script>
</body>
</html>
